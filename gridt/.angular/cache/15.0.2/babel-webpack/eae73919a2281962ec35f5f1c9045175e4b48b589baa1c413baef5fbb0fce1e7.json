{"ast":null,"code":"import { __awaiter, __generator } from \"tslib\";\nimport { AlertController } from '@ionic/angular';\nimport { Observable } from 'rxjs';\nimport { ApiService } from '../core/api.service';\nimport { SwapService } from '../core/swap.service';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../core/api.service\";\nimport * as i2 from \"@ionic/angular\";\nimport * as i3 from \"../core/swap.service\";\nimport * as i4 from \"@angular/common\";\nfunction HomePage_ion_grid_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"ion-grid\")(1, \"ion-row\")(2, \"ion-col\", 3)(3, \"p\");\n    i0.ɵɵtext(4, \" You haven't subscribed to any movements yet, let's do so now! \");\n    i0.ɵɵelement(5, \"ion-icon\", 4)(6, \"ion-icon\", 5);\n    i0.ɵɵtext(7, \" Movements can be found below: \");\n    i0.ɵɵelementStart(8, \"ion-button\", 6);\n    i0.ɵɵtext(9, \" Click me! \");\n    i0.ɵɵelementEnd()()()()();\n  }\n}\nfunction HomePage_ion_grid_9_ion_col_2_ion_item_15_small_9_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"small\");\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    var leader_r5 = i0.ɵɵnextContext().$implicit;\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate1(\" \", leader_r5.last_signal.message, \" \");\n  }\n}\nfunction HomePage_ion_grid_9_ion_col_2_ion_item_15_Template(rf, ctx) {\n  if (rf & 1) {\n    var _r10 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"ion-item\")(1, \"ion-avatar\", 0);\n    i0.ɵɵelement(2, \"img\", 14);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"ion-label\")(4, \"div\", 15)(5, \"h3\");\n    i0.ɵɵtext(6);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(7, \"p\");\n    i0.ɵɵtext(8);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵtemplate(9, HomePage_ion_grid_9_ion_col_2_ion_item_15_small_9_Template, 2, 1, \"small\", 2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(10, \"ion-button\", 16);\n    i0.ɵɵlistener(\"click\", function HomePage_ion_grid_9_ion_col_2_ion_item_15_Template_ion_button_click_10_listener() {\n      var restoredCtx = i0.ɵɵrestoreView(_r10);\n      var leader_r5 = restoredCtx.$implicit;\n      var movement_r3 = i0.ɵɵnextContext().$implicit;\n      var ctx_r8 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r8.confirmSwapLeader(movement_r3, leader_r5));\n    });\n    i0.ɵɵelement(11, \"ion-icon\", 17);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    var leader_r5 = ctx.$implicit;\n    var movement_r3 = i0.ɵɵnextContext().$implicit;\n    var ctx_r4 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(2);\n    i0.ɵɵpropertyInterpolate1(\"src\", \"https://gravatar.com/avatar/\", leader_r5.avatar, \"\", i0.ɵɵsanitizeUrl);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", leader_r5.username, \" \");\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(ctx_r4.isLeaderDone(leader_r5, movement_r3) ? \"Done!\" : \"Pending...\");\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", ctx_r4.isLeaderDone(leader_r5, movement_r3) && leader_r5.last_signal.message);\n    i0.ɵɵadvance(1);\n    i0.ɵɵattribute(\"disabled\", !ctx_r4.canSwap(movement_r3) ? \"\" : null);\n  }\n}\nfunction HomePage_ion_grid_9_ion_col_2_Template(rf, ctx) {\n  if (rf & 1) {\n    var _r13 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"ion-col\", 9)(1, \"ion-card\", 10)(2, \"ion-card-header\")(3, \"ion-card-title\");\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(5, \"ion-card-content\")(6, \"ion-grid\")(7, \"ion-row\")(8, \"ion-col\");\n    i0.ɵɵtext(9, \" Have you done it yet? \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(10, \"ion-col\")(11, \"ion-button\", 11);\n    i0.ɵɵlistener(\"click\", function HomePage_ion_grid_9_ion_col_2_Template_ion_button_click_11_listener() {\n      var restoredCtx = i0.ɵɵrestoreView(_r13);\n      var movement_r3 = restoredCtx.$implicit;\n      var ctx_r12 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r12.confirmSignal(movement_r3));\n    });\n    i0.ɵɵtext(12, \"Yes!\");\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(13, \"ion-row\")(14, \"ion-list\", 12);\n    i0.ɵɵtemplate(15, HomePage_ion_grid_9_ion_col_2_ion_item_15_Template, 12, 5, \"ion-item\", 13);\n    i0.ɵɵelementEnd()()()()()();\n  }\n  if (rf & 2) {\n    var movement_r3 = ctx.$implicit;\n    var ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate(movement_r3.name);\n    i0.ɵɵadvance(7);\n    i0.ɵɵattribute(\"disabled\", !ctx_r2.readyToSignal(movement_r3) ? \"\" : null);\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"ngForOf\", movement_r3.leaders);\n  }\n}\nfunction HomePage_ion_grid_9_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"ion-grid\")(1, \"ion-row\", 7);\n    i0.ɵɵtemplate(2, HomePage_ion_grid_9_ion_col_2_Template, 16, 3, \"ion-col\", 8);\n    i0.ɵɵpipe(3, \"async\");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    var ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngForOf\", i0.ɵɵpipeBind1(3, 1, ctx_r1.movements$));\n  }\n}\nvar HomePage = /** @class */function () {\n  function HomePage(api, alertCtrl, swapService) {\n    this.api = api;\n    this.alertCtrl = alertCtrl;\n    this.swapService = swapService;\n    this.movements$ = new Observable();\n  }\n  HomePage.prototype.ngOnInit = function () {\n    this.movements$ = this.api.subscriptions$;\n    this.api.getSubscriptions();\n  };\n  HomePage.prototype.ngOnDestroy = function () {};\n  /**\n   * Extract the timezone of a date string.\n   * @param date_string ISO Date string\n   */\n  HomePage.prototype.extract_timezone = function (date_string) {\n    return parseInt(date_string.match(/\\+(\\d\\d):\\d\\d/g)[0]);\n  };\n  /**\n   * Calculate when the last global signal reset was.\n   * @param interval Interval that on which the event is supposed to happen.\n   * @param hour_offset Timezone offset to account for the possibility that the server is not in the timezone of the client.\n   */\n  HomePage.prototype.getLastOccurence = function (interval, hour_offset) {\n    var date = new Date();\n    switch (interval) {\n      case \"daily\":\n        date.setUTCHours(hour_offset, 0, 0, 0);\n        break;\n      case \"twice daily\":\n        if (date.getUTCHours() < 12) {\n          date.setUTCHours(hour_offset, 0, 0, 0);\n        } else {\n          date.setUTCHours(hour_offset + 12, 0, 0, 0);\n        }\n        break;\n      case \"weekly\":\n        date.setUTCDate(date.getUTCDate() - date.getUTCDay());\n        date.setUTCHours(hour_offset, 0, 0, 0);\n        break;\n    }\n    return date;\n  };\n  /**\n   * Check if the user should be allowed to swap his leaders in this movement.\n   * @param movement Movement in which the leaders can be swapped or not.\n   */\n  HomePage.prototype.canSwap = function (movement) {\n    if (!movement.last_signal_sent) {\n      return false;\n    }\n    var last_signal_sent = new Date(movement.last_signal_sent.time_stamp);\n    var timezone;\n    for (var _i = 0, _a = movement.leaders; _i < _a.length; _i++) {\n      var leader = _a[_i];\n      if (leader.last_signal) {\n        timezone = this.extract_timezone(leader.last_signal.time_stamp);\n        break;\n      }\n    }\n    if (timezone === undefined) {\n      return true;\n    }\n    var last_reset = this.getLastOccurence(movement.interval, timezone);\n    if (this.swapService.getLastSwapEvent(movement)) {\n      var last_swap = this.swapService.getLastSwapEvent(movement).date;\n      return last_swap < last_reset && last_reset < last_signal_sent;\n    }\n    ;\n    return last_signal_sent > last_reset;\n  };\n  HomePage.prototype.isLeaderDone = function (leader, movement) {\n    var server_timezone = null;\n    var last_signal;\n    if (leader.last_signal) {\n      server_timezone = this.extract_timezone(leader.last_signal.time_stamp);\n      last_signal = new Date(Date.parse(leader.last_signal.time_stamp));\n    } else {\n      return false;\n    }\n    return this.getLastOccurence(movement.interval, server_timezone) < last_signal;\n  };\n  HomePage.prototype.confirmSwapLeader = function (movement, leader) {\n    return __awaiter(this, void 0, void 0, function () {\n      var el;\n      var _this = this;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4 /*yield*/, this.alertCtrl.create({\n              header: \"Confirm leader change\",\n              message: \"Are you sure you want to replace user \".concat(leader.username, \"\\\"?\"),\n              buttons: [{\n                text: \"Cancel\",\n                role: \"cancel\"\n              }, {\n                text: \"Yes\",\n                handler: function () {\n                  return _this.swapLeader(movement, leader);\n                }\n              }]\n            })];\n          case 1:\n            el = _a.sent();\n            el.present();\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n\n  HomePage.prototype.swapLeader = function (movement, leader) {\n    var _this = this;\n    this.swapService.addSwapEvent(movement, leader);\n    this.api.swapLeader$(movement, leader).subscribe(function (user) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var el;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              return [4 /*yield*/, this.alertCtrl.create({\n                header: \"Found new leader\",\n                message: \"Your new leader is \".concat(user.username, \".\"),\n                buttons: [\"okay\"]\n              })];\n            case 1:\n              el = _a.sent();\n              el.present();\n              return [2 /*return*/];\n          }\n        });\n      });\n    }, function (error) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var el;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              return [4 /*yield*/, this.alertCtrl.create({\n                header: \"No new leader found\",\n                message: \"We tried to find you a new user but: \".concat(error),\n                buttons: [\"okay...\"]\n              })];\n            case 1:\n              el = _a.sent();\n              el.present();\n              return [2 /*return*/];\n          }\n        });\n      });\n    });\n  };\n\n  HomePage.prototype.readyToSignal = function (movement) {\n    if (movement.last_signal_sent) {\n      var time_stamp = movement.last_signal_sent.time_stamp;\n      var server_timezone = this.extract_timezone(time_stamp);\n      var last_reset = this.getLastOccurence(movement.interval, server_timezone);\n      var last_signal = new Date(time_stamp);\n      return last_reset > last_signal;\n    } else {\n      return true;\n    }\n  };\n  HomePage.prototype.confirmSignal = function (movement) {\n    return __awaiter(this, void 0, void 0, function () {\n      var el;\n      var _this = this;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4 /*yield*/, this.alertCtrl.create({\n              header: \"Want to send a message with your signal?\",\n              message: '',\n              cssClass: \"confirmSignal-alert\",\n              inputs: [{\n                name: \"message\",\n                placeholder: \"message\",\n                type: \"text\"\n              }],\n              buttons: [{\n                text: \"Cancel\",\n                role: 'cancel'\n              }, {\n                text: \"Send!\",\n                handler: function (data) {\n                  if (data.message !== null && data.message.length < 140) {\n                    _this.signal(movement, data.message);\n                  } else if (data.message == null) {\n                    el.message = 'Your message is empty!';\n                    return false;\n                  } else if (data.message.length > 140) {\n                    el.message = 'Your message is longer than 140 characters!';\n                    return false;\n                  } else {\n                    el.message = 'Something went wrong, please try again.';\n                    return false;\n                  }\n                }\n              }]\n            })];\n          case 1:\n            el = _a.sent();\n            el.present();\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n\n  HomePage.prototype.signal = function (movement, message) {\n    return __awaiter(this, void 0, void 0, function () {\n      var _this = this;\n      return __generator(this, function (_a) {\n        this.api.sendSignal$(movement, message).subscribe(function () {\n          _this.api.getMovement$(movement.id).subscribe();\n        }, function (error) {\n          _this.alertCtrl.create({\n            header: 'Something went wrong while sending your signal.',\n            message: error,\n            buttons: ['Okay']\n          }).then(function (alertEl) {\n            return alertEl.present();\n          });\n        });\n        return [2 /*return*/];\n      });\n    });\n  };\n\n  HomePage.ɵfac = function HomePage_Factory(t) {\n    return new (t || HomePage)(i0.ɵɵdirectiveInject(i1.ApiService), i0.ɵɵdirectiveInject(i2.AlertController), i0.ɵɵdirectiveInject(i3.SwapService));\n  };\n  HomePage.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: HomePage,\n    selectors: [[\"app-home\"]],\n    decls: 11,\n    vars: 6,\n    consts: [[\"slot\", \"start\"], [\"paddinsearchTextg\", \"\"], [4, \"ngIf\"], [\"size\", \"12\", \"size-sm\", \"8\", \"offset-sm\", \"2\", \"text-center\", \"\"], [\"name\", \"bicycle-outline\"], [\"name\", \"star\"], [\"href\", \"/movements\", \"color\", \"success\", \"expand\", \"full\", \"shape\", \"round\"], [1, \"ion-justify-content-center\"], [\"offset-lg\", \"auto\", \"size-sm\", \"12\", \"size-md\", \"6\", \"size-lg\", \"4\", 4, \"ngFor\", \"ngForOf\"], [\"offset-lg\", \"auto\", \"size-sm\", \"12\", \"size-md\", \"6\", \"size-lg\", \"4\"], [1, \"movement-card\"], [3, \"click\"], [1, \"leader-list\"], [4, \"ngFor\", \"ngForOf\"], [3, \"src\"], [1, \"leader-container\"], [\"size\", \"small\", \"fill\", \"clear\", 3, \"click\"], [\"slot\", \"end\", \"name\", \"swap-horizontal-outline\"]],\n    template: function HomePage_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵelementStart(0, \"ion-header\")(1, \"ion-toolbar\")(2, \"ion-buttons\", 0);\n        i0.ɵɵelement(3, \"ion-menu-button\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(4, \"ion-title\");\n        i0.ɵɵtext(5, \"Home\");\n        i0.ɵɵelementEnd()()();\n        i0.ɵɵelementStart(6, \"ion-content\", 1);\n        i0.ɵɵtemplate(7, HomePage_ion_grid_7_Template, 10, 0, \"ion-grid\", 2);\n        i0.ɵɵpipe(8, \"async\");\n        i0.ɵɵtemplate(9, HomePage_ion_grid_9_Template, 4, 3, \"ion-grid\", 2);\n        i0.ɵɵpipe(10, \"async\");\n        i0.ɵɵelementEnd();\n      }\n      if (rf & 2) {\n        i0.ɵɵadvance(7);\n        i0.ɵɵproperty(\"ngIf\", ctx.movements$ && i0.ɵɵpipeBind1(8, 2, ctx.movements$).length === 0);\n        i0.ɵɵadvance(2);\n        i0.ɵɵproperty(\"ngIf\", ctx.movements$ && i0.ɵɵpipeBind1(10, 4, ctx.movements$).length > 0);\n      }\n    },\n    dependencies: [i4.NgForOf, i4.NgIf, i2.IonAvatar, i2.IonButton, i2.IonButtons, i2.IonCard, i2.IonCardContent, i2.IonCardHeader, i2.IonCardTitle, i2.IonCol, i2.IonContent, i2.IonGrid, i2.IonHeader, i2.IonIcon, i2.IonItem, i2.IonLabel, i2.IonList, i2.IonMenuButton, i2.IonRow, i2.IonTitle, i2.IonToolbar, i4.AsyncPipe],\n    styles: [\".leader-list[_ngcontent-%COMP%]{width:100%}.leader-container[_ngcontent-%COMP%]{display:flex;justify-content:space-between}.movement-card[_ngcontent-%COMP%]{margin:5px 5px 10px}\"]\n  });\n  return HomePage;\n}();\nexport { HomePage };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}